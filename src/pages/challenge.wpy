<style lang="less">
.titleImg{
  position: relative;
  width: 748rpx;
  border: 1rpx solid #dcdcdc;
  height: 272rpx;
}
.titleImg image{
  width: 100%;
  height: 100%;
}
.titleImg view{
  position:absolute;
  top:30rpx;
  right:20rpx;
  width:370rpx;
  height:60rpx;
  line-height: 60rpx;
  text-align: center;
  border:2rpx solid #f39900;
  color: #f39900;
  border-radius: 30rpx;
  color: #f39900;
  font-size: 30rpx;
}
.gradeSel{
  width: 750rpx;
  height: 120rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.gradeSel view{
  width: auto;
  height: 60rpx;
  line-height: 60rpx;
  padding: 0 20rpx;
  border: 1rpx solid #f39900;
  border-right: 0;
  font-size: 30rpx;
  color: #f39900;
  background-color: #fff;
}
.gradeSel view:last-of-type{
  border-right: 1rpx solid #f39900 !important;
}
.action{
  background-color: #f39900 !important;
  color: #fff !important;
}
// .gradeSel view:nth-child(4){
//   border-right: 1rpx solid #f39900 !important;
// }
.container{
  margin-bottom: 130rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.showContainer{
  width: 690rpx;
  border: 1rpx solid #e5e5e5;
  box-shadow: #e5e5e5 0rpx 0rpx 3rpx 3rpx;
  border-radius: 20rpx;
}
.signUp{
  height: 440rpx;
}
.signUpTitle{
  width: 672rpx;
  height: 116rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 10rpx;
}
.signUpTitle view:nth-child(1){
  width: 480rpx;
  height: 116rpx;
  line-height: 116rpx;
  font-size: 24rpx;
  color: #333;
  font-weight: 500;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.signUpTitle view:nth-child(2){
  width: 160rpx;
  height: 60rpx;
  line-height: 60rpx;
  font-size: 30rpx;
  text-align: center;
  color: #fff;
  margin-left: 20rpx;
  background-color: #f39900;
  border-radius: 15rpx;
}
.timeShow{
  width: 100%;
  height: 64rpx;
  font-size: 24rpx;
  line-height: 64rpx;
  margin-top: 20rpx;
  text-align: center;
}
.setSignUp{
  width: 100%;
  height: 94rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.setSignUp view{
  width: 240rpx;
  height: 54rpx;
  line-height: 54rpx;
  font-size: 30rpx;
  text-align: center;
  color: #fff;
  background-color: #f39900;
  border-radius: 27rpx;
}
.infoContainer{
  width: 100%;
  height: 138rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.info{
  width: 634rpx;
  height: 122rpx;
  border: 1rpx solid #f39900;
  border-radius: 20rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.infoContainer .count{
  width: auto;
  height: 122rpx;
  line-height: 122rpx;
  font-size: 40rpx;
  color: #f39900;
  padding: 20rpx;
}
.infoContainer .unit{
  width: 120rpx;
  height: 60rpx;
  line-height: 75rpx;
  text-align: center;
  border-right: 1rpx solid #e3e3e3;
  font-size: 23rpx;
  color: #555;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.description{
  width: 304rpx;
  padding: 0 30rpx;
}
.description view{
  width: 100%;
  height: 40rpx;
  line-height: 40rpx;
  font-size: 22rpx;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.reachData{
  
  text-align: center;
  font-size: 50rpx;
}
.reachTitle{
  text-align: center;
  font-size: 30rpx;
  height: 90rpx;
  line-height: 90rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.reachTitle view{
  width:160rpx;
  height:60rpx;
  line-height:60rpx;
  font-size:30rpx;
  text-align:center;
  color:#fff;
  margin-left:20rpx;
  background-color:#f39900;
  border-radius:15rpx;

}
.processing {
  height: 490rpx;
  margin-top: 50rpx;
}
.processing .info{
  border: 0rpx;
}
.infoShow{
  width: 33.3%;
  text-align: center;
}
.infoShow view{
  height: 40rpx;
  line-height: 40rpx;
  font-size: 22rpx;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.thisStatus{
  border-top: 1rpx solid #eee;
  height: 80rpx;
  line-height: 80rpx;
  text-align: center;
  color: #555;
  font-size: 22rpx;
}
.bulletBox{
  position: absolute;
  top: 220rpx;
  margin-left: 20rpx;
  margin-bottom: 40rpx;
  width: 670rpx;
  height: auto;
  background-color: #fcfcfc;
  padding:20rpx;
}
.bulletBoxTitle{
  height: 70rpx;
  line-height: 70rpx;
  color: #333;
  font-size: 30rpx;
  text-align: center;
}
.price{
  height: 70rpx;
  line-height: 70rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  border-bottom: 1rpx solid #dcdcdc;
}
.price view:nth-child(1){
  height: 70rpx;
  line-height: 70rpx;
  font-size: 46rpx;
  color: #333;
}
.price view:nth-child(2){
  height: 70rpx;
  line-height: 90rpx;
  font-size: 24rpx;
  color: #333;
}
.descriptionTitle{
  height: 90rpx;
  line-height: 90rpx;
  text-align: center;
  font-size: 30rpx;
  color: #333;
}
.conList{height: auto;}
.con{
  border: 1rpx solid #e5e5e5;
  border-radius: 20rpx;
  margin:30rpx 22rpx 0 22rpx;
  padding: 20rpx 60rpx;
  color: #333;
  font-size: 23rpx;
}
.con  view:nth-child(1){
  font-size: 32rpx;
}
.con  view:nth-child(2){
  margin-top: 20rpx;
}
.button{
  height: 240rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.button{
  width: 340rpx;
  height: 80rpx;
  line-height: 80rpx;
  text-align: center;
  color: #fff;
  font-size: 30rpx;
  border-radius: 40rpx;
  background-color: #f39900;
  margin: 80rpx 160rpx;
}
.scratch{
  display: flex;
  align-items: center;
  justify-content: center;
}
.scratch_wp{
  border: 1rpx solid #e5e5e5;
  border-radius: 20rpx;
  margin:30rpx 22rpx 0 22rpx;
  padding: 20rpx 60rpx;
  color: #333;
  font-size: 23rpx;
  position:relative;
  width: 300rpx;
  height: 200rpx;
}
.scratch_wp canvas{
  position: absolute;
  top:0;
  left:0;
  width: 100%;
  height: 100%;
  z-index: 999;
}
.scratch_wp view{
  position:absolute;
  top:0;
  left:0;
  width: 100%;
  height:100%;
  line-height: 200rpx;
  text-align: center;
  color: #fff;
  font-size: 30rpx;
  pointer-events:none;
  background-color: #f39900;
}
.hideRun{
  width: 50rpx;
  height: 50rpx;
  line-height: 50rpx;
  text-align: center;
  position: absolute;
  top: 10rpx;
  right: 20rpx;
  color: #333;
}
</style>
<template>
  <view>
    <view class="titleImg">
      <image src="{{imgUrl}}challengeTitle.jpg" />
      <view @tap="goDonationList">公益捐赠</view>
    </view>
    <view class="gradeSel">
      <!-- <view class="action" @tap="levelSel">3000步</view> -->
      <block wx:for="{{challengeList}}" key="index" index="index" item="item">
        <view class="{{level === item.id?'action':''}}" data-index="{{index}}" @tap="levelSel">{{item.min_step}}步</view>
      </block>
    </view>
    <view class="container">
      <view class="signUp showContainer">
        <view class="signUpTitle">
          <view>【{{year}}年{{month}}月{{date}}日/周{{day}}】{{challengeList[index].min_step}}步数挑战活动</view>
          <view>{{challengeList[index].status}}</view>
        </view>
        <view class="timeShow">倒计时{{remainingTimes}}</view>
        <view class="setSignUp">
          <view data-id="{{challengeList[index].id}}" @tap="participateShow">报名</view>
        </view>
        <view class="infoContainer">
          <view class="info">
            <view class="count">{{challengeList[index].get_bean}}</view>
            <view class="unit">动力豆</view>
            <view class="description">
              <view>达到{{challengeList[index].min_step}}步即可获得奖金</view>
              <view>{{challengeList[index].cost_bean}}动力豆报名</view>
            </view>
          </view>
        </view>
      </view>
      <block wx:for="{{historyList}}" key="index" index="index" item="item">
        <view class="processing showContainer">
          <view class="signUpTitle">
            <view>【{{item.deadline_date}}】{{item.challege_list.min_step}}步数挑战活动</view>
            <view>{{item.timeStatus}}</view>
          </view>
          <view class="reachData">{{item.step}}</view>
          <view class="reachTitle">
            <text wx:if="{{!item.update}}">{{item.status}}</text>
            <view wx:if="{{item.update}}" @tap="upResult">提交步数</view>
          </view>
          <view class="infoContainer">
            <view class="info">
              <view class="infoShow">
                <view>{{item.challege_list.get_bean}}</view>
                <view>获得收益</view>
              </view>
              <view class="infoShow">
                <view>{{item.participant_person}}</view>
                <view>参加人数</view>
              </view>
              <view class="infoShow">
                <view>{{item.allStep}}</view>
                <view>总奖励金</view>
              </view>
            </view>
          </view>
          <!-- <view class="thisStatus">您未参加该活动</view> -->
        </view>
      </block>
      <view class="dataNullTitle" wx:if="{{historyList.length==0}}">尚未参加过任何活动</view>
    </view>
    <view class="bulletBox" wx:if="{{wetherLuckyStar}}">
      <view class="hideRun" @tap="wetherLuckyStarHide">×</view>
      <view class="bulletBoxTitle">挑战成功,获得{{getBeans}}活力豆</view>
      <view class="descriptionTitle">恭喜成为幸运星,刮开卡片,查看奖品</view>
      <view class="scratch">
        <view class="scratch_wp">
          <canvas canvas-id="scratchCard" class="scratchCard"
            disable-scroll="false"
            bindtouchstart="touchStart"
            bindtouchmove="touchMove"
            bindtouchend="touchEnd">
          </canvas>
          <view class="scratch_txt" style="">{{100}}活力豆</view>
        </view>
      </view>
    </view>
    <view class="bulletBox" wx:if="{{participateDom}}">
      <view class="bulletBoxTitle">步数契约金</view>
      <view class="hideRun" @tap="participateHide">×</view>
      <view class="price">
        <view>{{challengeList[index].get_bean}}</view>
        <view>动力豆/人</view>
      </view>
      <view class="descriptionTitle">如何赚取步数奖励金？</view>
      <view class="conList">
        <view class="con">
          <view>报名参赛</view>
          <view>支付{{challengeList[index].get_bean}}活力豆步数契约金，即可加入明天的{{challengeList[index].min_step}}步天挑战活动</view>
        </view>
        <view class="con">
          <view>运动达标</view>
          <view>活动当日走的步数达标即可获得奖励资格</view>
        </view>
        <view class="con">
          <view>获得奖励</view>
          <view>比赛结束后达标用户平均分步数奖金</view>
        </view>
      </view>
      <view class="button">
        <view @tap="participate">确认报名</view>
      </view>
    </view>
    <!-- <nav @childFn.user="goPage" /> -->
  </view>
</template>

<script>
import wepy from 'wepy'
import nav from '../components/nav' // 底部导航
// import author from '../components/author' // 授权按钮
// 刮刮卡功能点,cnavas变量
const ctx = wx.createCanvasContext('scratchCard')
export default class Challenge extends wepy.page {
  config = {
    'navigationBarTitleText': '步数挑战'
  };
  // 生命组件ID
  components = {
  // 底部导航
    nav: nav
  };
  // alias example
  data = {
    userInfo: null,
    level: '1',
    challengeList: null,
    historyList: null,
    index: 0,
    year: 0,
    month: 0,
    date: 0,
    day: 0,
    remainingTimes: '0小时0分钟0秒',
    participateDom: false,
    challengeId: null,
    timer: null,
    todayStep: 0,
    startX: 0, // 保存X坐标轴变量(刮刮卡变量)
    startY: 0, // 保存X坐标轴变量(刮刮卡变量)
    wetherLuckyStar: false,
    getBeans: 0,
    imgUrl: ''
  };
  methods = {
    // 底部导航跳转
    goPage (url, evt) {
      // 销毁当前页{跳转}
      this.$redirect(url)
    }
  };
  async onLoad(options) {
    // 获取用户信息
    this.userInfo = this.$parent.globalData.userInfo
    this.imgUrl = this.$parent.globalData.imgUrl
    // 获取当前步数
    this.todayStep = this.$parent.globalData.todayStep
    // 获取挑战等级及相关数据
    this.getChallengeList()
    // 获取当天时间详情
    let timeData = new Date()
    this.year = timeData.getFullYear()
    this.month = timeData.getMonth() + 1
    this.date = timeData.getDate()
    this.day = timeData.getDay()
    if (this.day === 0) {
      this.day = '日'
    }
    this.$apply()
    // 剩余时间计算
    this.remainingTime()
  };
  // 获取挑战等级及相关数据
  getChallengeList() {
    wx.request({
      url: `${this.$parent.globalData.requestUrl}/api/challegeList`,
      method: 'GET',
      header: {
        AuthrizeOpenId: this.$parent.globalData.openId
      },
      success: data => {
        if (data.data.success) {
          // 获取挑战等级数据
          this.challengeList = data.data.data.challeges
          // 默认选中第一个等级
          this.level = this.challengeList[0].id
          this.$apply()
          // ---------------------
          // 获取参加的活动列表(已报名,进行中,已结束)
          this.historyList = data.data.data.user_challege_lists
          // 获取当天时间
          let thisTime = `${this.year}-${this.month}-${this.date}`
          // 时间格式转化
          thisTime = new Date(thisTime)
          for (let i in this.historyList) {
            // 计算总奖励金
            this.historyList[i].allStep = this.historyList[i].participant_person * this.historyList[i].challege_list.get_bean
            // 获取活动时间
            let date = new Date(this.historyList[i].deadline_date)
            // 对比时间获取状态
            if (date.getTime() === thisTime.getTime()) {
              // 当天进行的活动
              this.historyList[i].timeStatus = '进行中'
              this.historyList[i].update = true
              this.historyList[i].step = this.todayStep
            } else if (date.getTime() > thisTime.getTime()) {
              // 已报名,但未开启的活动,明天开启
              this.historyList[i].timeStatus = '待开启'
              this.historyList[i].status = '待开启'
              this.historyList[i].update = false
            } else {
              // 已经结束的活动
              this.historyList[i].timeStatus = '已结束'
              this.historyList[i].update = false
            }
          }
          this.$apply()
        }
      }
    })
  }
  // 提交挑战结果
  upResult() {
    wx.showModal({
      title: `当前${this.todayStep}活力豆`,
      content: `确认提交?`,
      success: res => {
        if (res.cancel) {
          // 点击取消,默认隐藏弹框
        } else {
          wx.request({
            url: `${this.$parent.globalData.requestUrl}/api/challegeResult`,
            method: 'POST',
            header: {
              AuthrizeOpenId: this.$parent.globalData.openId
            },
            data: {
              step: this.todayStep
            },
            success: data => {
              if (data.data.success) {
                // 控制刮刮卡是否显示
                data = data.data.data.challege_result
                if (data.data.data.wether_lucky_star) {
                  this.wetherLuckyStar = data.data.data.wether_lucky_star
                  this.getBeans = data.get_beans
                  this.$apply()
                  // 获取刮刮卡结果
                  this.clickGuaGua()
                } else {
                  wx.showModal({
                    title: '',
                    content: `挑战${data.status}，获取活力豆${data.get_beans}`
                  })
                }
              } else {
                wx.showModal({
                  title: '',
                  content: data.data.errmsg
                })
              }
            }
          })
        }
      }
    })
  }
  // 新运行弹出框隐藏
  wetherLuckyStarHide() {
    this.wetherLuckyStar = false
    this.$apply()
  }
  // 获取刮刮卡结果
  clickGuaGua() {
    wx.request({
      url: `${this.$parent.globalData.requestUrl}/api/clickGuaGua`,
      method: 'GET',
      header: {
        AuthrizeOpenId: this.$parent.globalData.openId
      },
      success: data => {
        if (data.data.success) {
            this.getBeans = data.get_beans
        }
      }
    })
  }
  // 选择挑战等级，更改相关数据显示
  levelSel(e) {
    this.index = e.currentTarget.dataset.index
    this.level = this.challengeList[this.index].id
    this.$apply()
  }
  // 参加挑战
  participateShow(e) {
    this.challengeId = e.currentTarget.dataset.id
    this.participateDom = true
    this.$apply()
  }
  // 隐藏弹出框
  participateHide() {
    this.participateDom = false
    this.$apply()
  }
  // 参加挑战
  participate(e) {
    this.participateDom = false
    this.$apply()
    if (this.userInfo.beans < this.challengeList[this.index].cost_bean) {
      wx.showModal({
        title: '',
        content: `当前活力豆余额为${this.userInfo.beans},数量不足`
      })
      return
    }
    let id = this.challengeId
    // 发送请求,参加挑战
    wx.request({
      url: `${this.$parent.globalData.requestUrl}/api/challengeRegistration`,
      method: 'POST',
      header: {
        AuthrizeOpenId: this.$parent.globalData.openId
      },
      data: {
        challege_id: id
      },
      success: data => {
        if (data.data.success) {
          wx.showModal({
            title: '',
            content: `${this.challengeList[this.index].min_step}步挑战报名成功`
          })
          // 刷新页面数据，更细列表
          this.getChallengeList()
        } else {
          wx.showModal({
            title: '',
            content: data.data.errmsg
          })
        }
      }
    })
  }
  // 剩余时间计算(毫秒)
  remainingTime() {
    let timeData = new Date()
    let hours = timeData.getHours()
    hours = hours * 60 * 60 * 1000
    let minutes = timeData.getMinutes()
    minutes = minutes * 60 * 1000
    let seconds = timeData.getSeconds()
    seconds = seconds * 1000
    let milliseconds = timeData.getMilliseconds()
    milliseconds += hours + minutes + seconds
    let times = 86400000 - milliseconds
    this.time(times)
  }
  // 剩余时间倒计时，内涵定时器，注意清理
  time(times) {
    this.timer = null
    this.timer = setInterval((e) => {
      let hour = 0
      let minute = 0
      let second = 0
      if (times > 0) {
        hour = parseInt(times / 1000 / 60 / 60 % 24, 10)
        minute = parseInt(times / 1000 / 60 % 60, 10)
        second = parseInt(times / 1000 % 60, 10)
      }
      if (hour <= 9) {
        hour = '0' + hour
      }
      if (minute <= 9) {
        minute = '0' + minute
      }
      if (second <= 9) {
        second = '0' + second
      }
      this.remainingTimes = `${hour}小时${minute}分钟${second}秒`
      this.$apply()
      times -= 1000
    }, 1000)
    if (times <= 0) {
      clearInterval(this.timer)
    }
  }
  // 页面隐藏
  onHide() {
    // 清理定时器
    clearInterval(this.timer)
  }
  /**
  * 生命周期函数--监听页面卸载
  */
  onUnload() {
    // 清理定时器
    clearInterval(this.timer)
  }
  // 公益捐赠列表
  goDonationList() {
    this.$navigate('/pages/donationList')
  }
  // =================刮刮卡相关函数==============================
  onReady() {
    ctx.setFillStyle('#EFEFEF')
    ctx.fillRect(0, 0, 240, 150.75)
    ctx.draw()
  }
  touchStart(e) {
    var startX1 = e.changedTouches[0].x
    var startY1 = e.changedTouches[0].y
    // 保存当前坐标轴的缩放、旋转、平移信息
    ctx.save()
    // 开始一个路径
    ctx.beginPath()
    ctx.clearRect(startX1, startY1, 10, 10)
    // 恢复之前保存过的坐标轴的缩放、旋转、平移信息
    ctx.restore()
  }
  touchMove(e) {
    var startX1 = e.changedTouches[0].x
    var startY1 = e.changedTouches[0].y
    // 保存当前坐标轴的缩放、旋转、平移信息
    ctx.save()
    // 把路径移动到画布中的指定点，但不创建线条
    ctx.moveTo(this.startX, this.startY)
    // 添加一个新点，然后在画布中创建从该点到最后指定点的线条
    ctx.clearRect(startX1, startY1, 30, 30)
    // 恢复之前保存过的坐标轴的缩放、旋转、平移信息
    ctx.restore()
    this.startX = startX1
    this.startY = startY1
    // 只是一个记录方法调用的容器，用于生成记录绘制行为的actions数组。context跟<canvas/>不存在对应关系，一个context生成画布的绘制动作数组可以应用于多个<canvas/>
    wx.drawCanvas({
      canvasId: 'scratchCard',
      reserve: true,
      // 获取绘图动作数组
      actions: ctx.getActions()
    })
  }
  // ===============================================
}
</script>
