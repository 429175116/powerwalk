<style lang="less">
.titleImg{
  position: relative;
  width: 748rpx;
  border: 1rpx solid #dcdcdc;
  height: 272rpx;
}
.titleImg image{
  width: 100%;
  height: 100%;
}
.titleImg view{
  position:absolute;
  top:30rpx;
  right:20rpx;
  width:370rpx;
  height:60rpx;
  line-height: 60rpx;
  text-align: center;
  border:2rpx solid #f39900;
  border-radius: 30rpx;
  color: #333;
  font-size: 30rpx;
}
.gradeSel{
  width: 750rpx;
  height: 120rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.gradeSel view{
  width: auto;
  height: 60rpx;
  line-height: 60rpx;
  padding: 0 20rpx;
  border: 1rpx solid #f39900;
  border-right: 0;
  font-size: 30rpx;
  color: #f39900;
  background-color: #fff;
}
.gradeSel view:last-of-type{
  border-right: 1rpx solid #f39900 !important;
}
.action{
  background-color: #f39900 !important;
  color: #fff !important;
}
// .gradeSel view:nth-child(4){
//   border-right: 1rpx solid #f39900 !important;
// }
.container{
  margin-bottom: 130rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.showContainer{
  width: 690rpx;
  border: 1rpx solid #e5e5e5;
  box-shadow: #e5e5e5 0rpx 0rpx 3rpx 3rpx;
  border-radius: 20rpx;
}
.signUp{
  height: 440rpx;
}
.signUpTitle{
  width: 672rpx;
  height: 116rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 10rpx;
}
.signUpTitle view:nth-child(1){
  width: 480rpx;
  height: 116rpx;
  line-height: 116rpx;
  font-size: 24rpx;
  color: #333;
  font-weight: 500;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.signUpTitle view:nth-child(2){
  width: 160rpx;
  height: 60rpx;
  line-height: 60rpx;
  font-size: 30rpx;
  text-align: center;
  color: #fff;
  margin-left: 20rpx;
  background-color: #f39900;
  border-radius: 15rpx;
}
.timeShow{
  width: 100%;
  height: 64rpx;
  font-size: 24rpx;
  line-height: 64rpx;
  margin-top: 20rpx;
  text-align: center;
}
.setSignUp{
  width: 100%;
  height: 94rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.setSignUp view{
  width: 240rpx;
  height: 54rpx;
  line-height: 54rpx;
  font-size: 30rpx;
  text-align: center;
  color: #fff;
  background-color: #f39900;
  border-radius: 27rpx;
}
.infoContainer{
  width: 100%;
  height: 138rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.info{
  width: 634rpx;
  height: 122rpx;
  border: 1rpx solid #f39900;
  border-radius: 20rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.infoContainer .count{
  width: auto;
  height: 122rpx;
  line-height: 122rpx;
  font-size: 40rpx;
  color: #f39900;
  padding: 20rpx;
}
.infoContainer .unit{
  width: 120rpx;
  height: 60rpx;
  line-height: 75rpx;
  text-align: center;
  border-right: 1rpx solid #e3e3e3;
  font-size: 23rpx;
  color: #555;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.description{
  width: 304rpx;
  padding: 0 30rpx;
}
.description view{
  width: 100%;
  height: 40rpx;
  line-height: 40rpx;
  font-size: 22rpx;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.reachData{
  
  text-align: center;
  font-size: 50rpx;
}
.reachTitle{
  text-align: center;
  font-size: 30rpx;
  height: 90rpx;
  line-height: 90rpx;
}
.processing {
  height: 490rpx;
  margin-top: 50rpx;
}
.processing .info{
  border: 0rpx;
}
.infoShow{
  width: 33.3%;
  text-align: center;
}
.infoShow view{
  height: 40rpx;
  line-height: 40rpx;
  font-size: 22rpx;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.thisStatus{
  border-top: 1rpx solid #eee;
  height: 80rpx;
  line-height: 80rpx;
  text-align: center;
  color: #555;
  font-size: 22rpx;
}
.bulletBox{
  position: absolute;
  top: 220rpx;
  margin-left: 20rpx;
  width: 670rpx;
  height: 1200rpx;
  background-color: #fcfcfc;
  padding:20rpx;
}
.bulletBoxTitle{
  height: 70rpx;
  line-height: 70rpx;
  color: #333;
  font-size: 30rpx;
  text-align: center;
}
.price{
  height: 70rpx;
  line-height: 70rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  border-bottom: 1rpx solid #dcdcdc;
}
.price view:nth-child(1){
  height: 70rpx;
  line-height: 70rpx;
  font-size: 46rpx;
  color: #333;
}
.price view:nth-child(2){
  height: 70rpx;
  line-height: 90rpx;
  font-size: 24rpx;
  color: #333;
}
.descriptionTitle{
  height: 90rpx;
  line-height: 90rpx;
  text-align: center;
  font-size: 30rpx;
  color: #333;
}
.conList{height: auto;}
.con{
  border: 1rpx solid #e5e5e5;
  border-radius: 20rpx;
  margin:30rpx 22rpx 0 22rpx;
  padding: 20rpx 60rpx;
  color: #333;
  font-size: 23rpx;
}
.con  view:nth-child(1){
  font-size: 32rpx;
}
.con  view:nth-child(2){
  margin-top: 20rpx;
}
.button{
  height: 240rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
.button{
  width: 340rpx;
  height: 80rpx;
  line-height: 80rpx;
  text-align: center;
  color: #fff;
  font-size: 30rpx;
  border-radius: 40rpx;
  background-color: #f39900;
  margin: 80rpx 160rpx;
}
</style>
<template>
  <view>
    <view class="titleImg">
      <image src="/img/challengeTitle.png" />
      <view @tap="goDonationList">公益捐赠</view>
    </view>
    <view class="gradeSel">
      <!-- <view class="action" @tap="levelSel">3000步</view> -->
      <block wx:for="{{challengeList}}" key="index" index="index" item="item">
        <view class="{{level === item.id?'action':''}}" data-index="{{index}}" @tap="levelSel">{{item.min_step}}步</view>
      </block>
    </view>
    <view class="container">
      <view class="signUp showContainer">
        <view class="signUpTitle">
          <view>【{{year}}年{{month}}月{{date}}日/周{{day}}】{{challengeList[index].min_step}}步数挑战活动</view>
          <view>{{challengeList[index].status}}</view>
        </view>
        <view class="timeShow">倒计时{{remainingTimes}}</view>
        <view class="setSignUp">
          <view data-id="{{challengeList[index].id}}" @tap="participateShow">报名</view>
        </view>
        <view class="infoContainer">
          <view class="info">
            <view class="count">{{challengeList[index].get_bean}}</view>
            <view class="unit">动力豆</view>
            <view class="description">
              <view>达到{{challengeList[index].min_step}}步即可评分奖金</view>
              <view>{{challengeList[index].cost_bean}}动力豆报名,已有2人参与</view>
            </view>
          </view>
        </view>
      </view>
      <view class="processing showContainer">
        <view class="signUpTitle">
          <view>【2018年8月28日/周三】3000步数挑战活动</view>
          <view>进行中</view>
        </view>
        <view class="reachData">10</view>
        <view class="reachTitle">达成目标</view>
        <view class="infoContainer">
          <view class="info">
            <view class="infoShow">
              <view>达到3000步</view>
              <view>50动力豆报</view>
            </view>
            <view class="infoShow">
              <view>达到3000</view>
              <view>50动力豆</view>
            </view>
            <view class="infoShow">
              <view>达到3000步</view>
              <view>50动力</view>
            </view>
          </view>
        </view>
        <view class="thisStatus">您未参加该活动</view>
      </view>
    </view>
    
    <view class="bulletBox" wx:if="{{participateDom}}">
      <view class="bulletBoxTitle">步数契约金</view>
      <view class="price">
        <view>10</view>
        <view>动力豆/人</view>
      </view>
      <view class="descriptionTitle">如何赚取步数奖励金？</view>
      <view class="conList">
        <view class="con">
          <view>报名参赛</view>
          <view>如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？</view>
        </view>
        <view class="con">
          <view>报名参赛</view>
          <view>如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？</view>
        </view>
        <view class="con">
          <view>报名参赛</view>
          <view>如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？如何赚取步数奖励金？</view>
        </view>
      </view>
      <view class="button">
        <view @tap="participate">确认报名</view>
      </view>
    </view>
    <nav @childFn.user="goPage" />
  </view>
</template>

<script>
import wepy from 'wepy'
import nav from '../components/nav' // 底部导航
// import author from '../components/author' // 授权按钮
export default class Challenge extends wepy.page {
  config = {
    'navigationBarTitleText': '步数挑战'
  };
  // 生命组件ID
  components = {
  // 底部导航
    nav: nav
  };
  // alias example
  data = {
    userInfo: null,
    level: '1',
    challengeList: null,
    index: 0,
    year: 0,
    month: 0,
    date: 0,
    day: 0,
    remainingTimes: '0小时0分钟0秒',
    participateDom: false,
    challengeId: null,
    timer: null
  };
  methods = {
    // 底部导航跳转
    goPage (url, evt) {
      // 销毁当前页{跳转}
      this.$redirect(url)
    }
  };
  async onLoad(options) {
    // 获取用户信息
    this.userInfo = this.$parent.globalData.userInfo
    // 获取挑战等级及相关数据
    this.getChallengeList()
    this.upResult()
    // 获取当天时间详情
    let timeData = new Date()
    this.year = timeData.getFullYear()
    this.month = timeData.getMonth() + 1
    this.date = timeData.getDate()
    this.day = timeData.getDay()
    if (this.day === 0) {
      this.day = '日'
    }
    this.$apply()
    // 剩余时间计算
    this.remainingTime()
  };
  // 获取挑战等级及相关数据
  getChallengeList() {
    wx.request({
      url: `${this.$parent.globalData.requestUrl}/api/challegeList`,
      method: 'GET',
      success: data => {
        if (data.data.success) {
          this.challengeList = data.data.data.challeges
          // "id": 1,
          // "min_step": 10000,达标步数
          // "get_bean": 1000,达标后可获得活力豆
          // "status": "启用",状态
          // "cost_bean": 500,报名费用(活力豆)
          this.level = this.challengeList[0].id
          this.$apply()
        }
      }
    })
  }
  // 提交挑战结果
  upResult() {
    wx.request({
      url: `${this.$parent.globalData.requestUrl}/api/challegeResult`,
      method: 'POST',
      header: {
        AuthrizeOpenId: this.$parent.globalData.openId
      },
      data: {
        step: this.$parent.globalData.todayStep
      },
      success: data => {
        if (data.data.success) {
          // 控制刮刮卡是否显示  /components/scratch/
          this.wetherLuckyStar = data.data.data.wether_lucky_star
          data = data.data.data.challege_result
          wx.showModal({
            title: '',
            content: `挑战${data.status}，获取活力豆${data.get_beans}`
          })
        } else {
          wx.showModal({
            title: '',
            content: '挑战失败'
          })
        }
      }
    })
  }
  // 选择挑战等级，更改相关数据显示
  levelSel(e) {
    this.index = e.currentTarget.dataset.index
    this.level = this.challengeList[this.index].id
    this.$apply()
  }
  // 参加挑战
  participateShow(e){
    this.challengeId = e.currentTarget.dataset.id
    this.participateDom = true
    this.$apply()
  }
  // 参加挑战
  participate(e) {
    this.participateDom = false
    this.$apply()
    if (this.userInfo.beans < this.challengeList[this.index].cost_bean) {
      wx.showModal({
        title: '',
        content: `当前活力豆余额为${this.userInfo.beans},数量不足`
      })
      return
    }
    let id = this.challengeId
    // 发送请求,参加挑战
    wx.request({
      url: `${this.$parent.globalData.requestUrl}/api/challengeRegistration`,
      method: 'POST',
      header: {
        AuthrizeOpenId: this.$parent.globalData.openId
      },
      data: {
        challege_id: id
      },
      success: data => {
        if (data.data.success) {
          wx.showModal({
            title: '',
            content: `${this.challengeList[this.index].min_step}步挑战报名成功`
          })
        } else {
          wx.showModal({
            title: '',
            content: data.data.errmsg
          })
        }
      }
    })
  }
  // 剩余时间计算(毫秒)
  remainingTime() {
    let timeData = new Date()
    let hours = timeData.getHours()
    hours = hours * 60 * 60 * 1000
    let minutes = timeData.getMinutes()
    minutes = minutes * 60 * 1000
    let seconds = timeData.getSeconds()
    seconds = seconds * 1000
    let milliseconds = timeData.getMilliseconds()
    milliseconds += hours + minutes + seconds
    let times = 86400000 - milliseconds
    this.time(times)
  }
  // 剩余时间倒计时，内涵定时器，注意清理
  time(times) {
    this.timer = null
    this.timer = setInterval( e => {
    let day = 0
    let hour = 0
    let minute = 0
    let second = 0
    if(times > 0){
      hour = parseInt(times / 1000 / 60 / 60 % 24, 10)
      minute = parseInt(times / 1000 / 60 % 60, 10)
      second = parseInt(times / 1000 % 60, 10)
    }
    if (hour <= 9) hour = '0' + hour
    if (minute <= 9) minute = '0' + minute
    if (second <= 9) second = '0' + second
      this.remainingTimes = `${hour}小时${minute}分钟${second}秒`
      this.$apply()
      times -= 1000;
    }, 1000);
    if(times<=0){
      clearInterval(this.timer)
    }
  }

  // 页面隐藏
  onHide() {
    // 清理定时器
    clearInterval(this.timer)
  }
  /**
  * 生命周期函数--监听页面卸载
  */
  onUnload() {
    // 清理定时器
    clearInterval(this.timer)
  }
  // 公益捐赠列表
  goDonationList() {
    this.$navigate('/pages/donationList')
  }
}
</script>
